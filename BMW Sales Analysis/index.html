<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Car Sales Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #0d0d1a, #1a1033);
      color: white;
    }
    header {
      text-align: center;
      padding: 2rem;
      font-size: 2rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.05);
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 2rem;
    }
    .filter {
      margin-bottom: 1.5rem;
    }
    select {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      backdrop-filter: blur(10px);
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
    }
    .chart-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1rem;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    canvas {
      width: 100% !important;
      height: 350px !important;
    }
  </style>
</head>
<body>
  <header>üöò Car Sales Dashboard</header>
  <div class="container">
    <div class="filter">
      <label for="yearFilter">Filter by Year: </label>
      <select id="yearFilter">
        <option value="All">All</option>
      </select>
    </div>
    <div class="charts">
      <div class="chart-card"><canvas id="salesVolumeChart"></canvas></div>
      <div class="chart-card"><canvas id="priceChart"></canvas></div>
      <div class="chart-card"><canvas id="fuelTypeChart"></canvas></div>
      <div class="chart-card"><canvas id="transmissionChart"></canvas></div>
    </div>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSbkKYeVn1qV4pJKqtTnbD7CLYiJ-ZP3dQjFdpT0nbrxtgW4jl2BuejOYY5GKBzkmFzrxGxrIwOA7tP/pub?output=csv";

    let rawData = [];
    let charts = {};

    // Parse CSV into array of objects
    function parseCSV(text) {
      const rows = text.split("\n").map(r => r.split(","));
      const headers = rows[0];
      return rows.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = row[i] ? row[i].trim() : "";
        });
        return obj;
      });
    }

    async function loadData() {
      try {
        const response = await fetch(sheetURL);
        const text = await response.text();
        rawData = parseCSV(text);
        populateYearFilter();
        renderCharts("All");
      } catch (err) {
        console.error("Error loading sheet:", err);
        document.body.innerHTML = "<h2 style='color:red;text-align:center;'>‚ùå Error loading sheet data</h2>";
      }
    }

    function populateYearFilter() {
      const yearSet = new Set(rawData.map(d => d["Year"]));
      const yearFilter = document.getElementById("yearFilter");
      yearSet.forEach(year => {
        let opt = document.createElement("option");
        opt.value = year;
        opt.textContent = year;
        yearFilter.appendChild(opt);
      });
      yearFilter.addEventListener("change", () => renderCharts(yearFilter.value));
    }

    function renderCharts(year) {
      let data = year === "All" ? rawData : rawData.filter(d => d["Year"] === year);

      // Sales Volume by Model (Bar)
      let models = [...new Set(data.map(d => d.Model))];
      let salesVolume = models.map(m => {
        return data.filter(d => d.Model === m).reduce((sum, d) => sum + Number(d.Sales_Volume || 0), 0);
      });

      createChart("salesVolumeChart", "bar", {
        labels: models,
        datasets: [{ label: "Sales Volume", data: salesVolume, backgroundColor: "rgba(0, 123, 255, 0.6)" }]
      });

      // Average Price by Model (Line)
      let avgPrice = models.map(m => {
        let items = data.filter(d => d.Model === m);
        return items.reduce((sum, d) => sum + Number(d.Price_USD || 0), 0) / (items.length || 1);
      });

      createChart("priceChart", "line", {
        labels: models,
        datasets: [{ label: "Avg Price (USD)", data: avgPrice, borderColor: "#ff6384", fill: true }]
      });

      // Fuel Type Distribution (Donut)
      let fuels = [...new Set(data.map(d => d.Fuel_Type))];
      let fuelCounts = fuels.map(f => data.filter(d => d.Fuel_Type === f).length);

      createChart("fuelTypeChart", "doughnut", {
        labels: fuels,
        datasets: [{ data: fuelCounts, backgroundColor: ["#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff"] }]
      });

      // Transmission Count (Pie)
      let trans = [...new Set(data.map(d => d.Transmission))];
      let transCounts = trans.map(t => data.filter(d => d.Transmission === t).length);

      createChart("transmissionChart", "pie", {
        labels: trans,
        datasets: [{ data: transCounts, backgroundColor: ["#ff6384", "#36a2eb", "#ff9f40"] }]
      });
    }

    function createChart(id, type, data) {
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), { type, data });
    }

    loadData();
  </script>
</body>
</html>